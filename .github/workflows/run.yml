name: Generate Workdir

on:
  workflow_call:
    secrets:
      LW_LOGIN:
        required: true
      LW_PASSWORD:
        required: true
      CALLER_GITHUB_TOKEN:
        required: true

jobs:
  run:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout YOUR repo (generator code)
      - name: Checkout generator repo
        uses: actions/checkout@v4
        with:
          path: generator

      # 2️⃣ Setup Bun
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      # 3️⃣ Install deps (YOUR repo)
      - name: Install deps
        working-directory: generator
        run: bun install

      # 4️⃣ Run generator (output stays in YOUR repo)
      - name: Run workdir generation
        working-directory: generator
        env:
          LW_LOGIN: ${{ secrets.LW_LOGIN }}
          LW_PASSWORD: ${{ secrets.LW_PASSWORD }}
        run: bun run start workdir

      # 5️⃣ Checkout CALLER repo (empty is fine)
      - name: Checkout caller repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.CALLER_GITHUB_TOKEN }}
          path: caller

      # 6️⃣ Copy generated folder into caller repo
      - name: Copy workdir to caller repo
        run: |
          rm -rf caller/workdir
          cp -R generator/workdir caller/workdir

      # 7️⃣ Commit & push to caller repo
      - name: Commit and push
        working-directory: caller
        run: |
          set -e
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          if [ -n "$(git status --porcelain)" ]; then
            git add workdir
            git commit -m "chore: generate workdir"
            git push
          else
            echo "No changes to commit."
          fi
